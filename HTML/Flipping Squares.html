<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1">
    <title>Flipping Squares — Keep Talking and Nobody Explodes Module</title>
    <link rel="stylesheet" type='text/css' href="css/font.css">
    <link rel="stylesheet" type="text/css" href="css/normalize.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script src="js/ktane-utils.js"></script>
    <style>
        .configs {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
            .configs > div {
                width: 2.1cm;
                margin: .2cm 0;
            }
                .configs > div > div.sn {
                    text-align: center;
                    font-weight: bold;
                    margin: .1cm 0 0;
                }
                .configs > div > svg {
                    display: block;
                }
    </style>
</head>
<body>
    <div class="section">
        <div class="page page-bg-01">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">Flipping Squares</span>
            </div>
            <div class="page-content">
                <img src="img/Component/Flipping Squares.svg" class="diagram">
                <h2>On the Subject of Flipping Squares</h2>
                <p class="flavour-text">With every added move, the search space just... blows up.</p>

                <p>Press any square to perform a flip.</p>
                <p>Long-press (&gt; .3 sec) any square to return to the original configuration.</p>
                <p>Use the first character of the serial number to determine which configuration the arrows need to be in (the dot is the status light):</p>
                <div id='arrow-configs' class='configs'></div>

                <p style='margin-top: 1cm'>Use the last character of the serial number to determine which configuration the colors need to be in:</p>
                <div id='color-configs' class='configs'></div>
                <p>Colors are: R = red, O = orange, Y = yellow, G = green, C = cyan, Z = azure, B = blue, P = purple, I = pink.</p>
            </div>
            <div class="page-footer relative-footer">Page 1 of 1</div>
        </div>
    </div>
    <script>
        function mkSvg(fncCol, fncInner)
        {
            let c = Array(9).fill(null);
            return `
                <svg viewBox='-.5 -.5 31 31' font-size='6'>
                    ${c.map((_, ix) => `
                        <g transform='translate(${10*(ix % 3)}, ${10*((ix / 3) | 0)})'>
                            <rect fill='${fncCol(ix)}' width='10' height='10' />
                            <path fill='rgba(0, 0, 0, .3)' d='M10 0v10h-10l1 -1h8v-8z' />
                            <path fill='rgba(255, 255, 255, .5)' d='M0 10v-10h10l-1 1h-8v8z' />
                        <${''}/g>
                    `)
                        .join('')}
                    ${c.map((_, ix) => fncInner(ix))
                        .join('')}
                <${''}/svg>`;
        }

        function mkSq(sn, n, fncCol, fncInner)
        {
            return Array(n).fill(null).map((_, cfgIx) => `
                <div class='cfg'>
                    <div class='sn'>${sn[cfgIx].split('').join('/')}<${''}/div>
                    ${mkSvg(fncCol(cfgIx), fncInner(cfgIx))}
                <${''}/div>
            `).join('');
        }

        let arrowConfigs = [];
        let arrowD = 'm 2.01e-4,-4.902 c -0.632551,1.2651 -1.2651,2.5302 -2.530201,3.795302 0.793599,-0.340114 1.382063,-0.553566 1.914947,-0.649848 0.298978,2.231223 -0.333571,4.761423 -0.966122,6.659074 0.948825,-0.316275 2.213927,-0.316275 3.162752,0 -0.632551,-1.897651 -1.2651,-4.427851 -0.966122,-6.659074 0.532884,0.09628 1.121348,0.309734 1.914947,0.649848 C 1.265301,-2.3718 0.632752,-3.6369 2.01e-4,-4.902 Z';
        for (let i = 0; i < 8; i++)
            arrowConfigs.push([ 0, 1, 2, 7, -1, 3, 6, 5, 4 ].map(ar => ar < 0 ? ar : (ar + i) % 8));
        for (let i = 0; i < 8; i++)
            arrowConfigs.push([ 0, 1, 2, 7, -1, 3, 6, 5, 4 ].map(ar => ar < 0 ? ar : ((7-ar) + i) % 8));
        let snArrows = '0O,1I,2G,3H,4JW,5K,6L,7M,8N,9PX,AQ,BRY,CS,DT,EU,FVZ'.split(',');

        document.getElementById('arrow-configs').innerHTML = mkSq(snArrows, 16, _ => _ => '#ddd', cfgIx => ix => arrowConfigs[cfgIx][ix] === -1
            ? `<circle cx='${10*(ix % 3) + 5}' cy='${10*((ix / 3) | 0) + 5}' r='1.5' />`
            : `<path transform='translate(${10*(ix % 3) + 5}, ${10*((ix / 3) | 0) + 5}) scale(.7) rotate(${-45 + 45*arrowConfigs[cfgIx][ix]})' d='${arrowD}' />`);

        let colorConfigs = [];
        for (let flip = 0; flip < 2; flip++)
            for (let rot = 0; rot < 4; rot++)
            {
                let arr = Array(9).fill(null).map((_, c) => ({ x: c % 3, y: (c / 3) | 0 }));
                if (flip)
                    arr = arr.map(c => ({ x: (2-c.x), y: c.y }));
                for (let r = 0; r < rot; r++)
                    arr = arr.map(c => ({ x: c.y, y: 2-c.x }));
                colorConfigs.push(arr);
            }

        let colors = [
            {name: 'R', r: 1, g: 0.32549018, b: 0.32549018},
            {name: 'O', r: 1, g: 0.6636845, b: 0.32549018},
            {name: 'Y', r: 1, g: 1, b: 0.32549018},
            {name: 'G', r: 0.54719543, g: 1, b: 0.32549018},
            {name: 'C', r: 0.32549018, g: 1, b: 0.78017366},
            {name: 'Z', r: 0.32549018, g: 0.6561692, b: 1},
            {name: 'B', r: 0.33300543, g: 0.32549018, b: 1},
            {name: 'P', r: 0.67120016, g: 0.32549018, b: 1},
            {name: 'I', r: 1, g: 0.32549018, b: 0.9906058}
        ];
        let snColors = '08,19,2,3,4,5,6,7'.split(',');

        console.log(colorConfigs.map(cs => cs.map(c => c.x + 3*c.y)));

        document.getElementById('color-configs').innerHTML = mkSq(snColors, 8,
            cfgIx => ix => {
                let cObj = colorConfigs[cfgIx][ix];
                let c = colors [ cObj.x + 3*cObj.y ];
                return `#${((c.r*255)|0).toString(16).padStart(2, '0')}${((c.g*255)|0).toString(16).padStart(2, '0')}${((c.b*255)|0).toString(16).padStart(2, '0')}`;
            },
            cfgIx => ix => {
                let cObj = colorConfigs[cfgIx][ix];
                let c = colors [ cObj.x + 3*cObj.y ];
                return `<text x='${10*(ix % 3) + 5}' y='${10*((ix / 3) | 0) + 7}' text-anchor='middle'>${c.name}<${''}/text>`;
            });

    </script>
</body>
</html>